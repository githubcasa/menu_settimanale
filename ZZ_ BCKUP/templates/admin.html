<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Statistiche Voti</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 40px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        h1 {
            font-size: 24px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 13px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .date-selector {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            width: 100%;
        }
        
        .date-selector label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .date-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .piatto-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stars-display {
            font-size: 24px;
            color: #ffd700;
        }
        
        .rating-number {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }
        
        .vote-count {
            color: #666;
            font-size: 14px;
        }
        
        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .comments-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .comment-item {
            background: #f9f9f9;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .comment-user {
            font-weight: 600;
            color: #667eea;
            margin-right: 5px;
        }
        
        .comment-text {
            color: #666;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .summary-title {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .summary-number {
            font-size: 48px;
            font-weight: 700;
        }
        
        .refresh-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üìä Statistiche Voti</h1>
            <div class="header-buttons">
                <a href="/valida_csv" class="back-btn">üîç Valida CSV</a>
                <a href="/ingredienti" class="back-btn">üõí Lista Spesa</a>
                <a href="/" class="back-btn">‚Üê Menu</a>
            </div>
        </div>
        <div class="date-selector">
            <label for="dataMenu">üìÖ Seleziona data:</label>
            <select id="dataMenu" onchange="cambiaData()">
                <option value="">Caricamento...</option>
            </select>
        </div>
    </div>
    
    <div class="container">
        <button class="refresh-btn" onclick="loadStats()">üîÑ Aggiorna</button>
        <div id="statsContainer">
            <div class="loading">
                <div class="spinner"></div>
                Caricamento statistiche...
            </div>
        </div>
    </div>
    
    <script>
        let menuData = null;
        let currentDate = new Date().toISOString().split('T')[0];
        
        async function loadAvailableDates() {
            try {
                const response = await fetch('/api/date_disponibili');
                const data = await response.json();
                
                const select = document.getElementById('dataMenu');
                select.innerHTML = '';
                
                if (data.date && data.date.length > 0) {
                    data.date.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = formatDateItalian(date);
                        if (date === currentDate) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Nessuna data disponibile</option>';
                }
            } catch (error) {
                console.error('Errore caricamento date:', error);
            }
        }
        
        function formatDateItalian(dateString) {
            if (!dateString) return 'Data non valida';
            
            try {
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString;
                
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                
                const date = new Date(year, month, day);
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                return date.toLocaleDateString('it-IT', { 
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            } catch (e) {
                console.error('Errore formattazione data:', e);
                return dateString;
            }
        }
        
        async function loadMenu() {
            try {
                const response = await fetch(`/api/menu?data=${currentDate}`);
                menuData = await response.json();
            } catch (error) {
                console.error('Errore caricamento menu:', error);
            }
        }
        
        async function loadStats() {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Caricamento statistiche...</div>';
            
            try {
                await loadMenu();
                
                const response = await fetch(`/api/statistiche?data=${currentDate}`);
                if (response.status === 403) {
                    container.innerHTML = '<div class="no-data">‚ùå Accesso negato.</div>';
                    return;
                }
                
                const stats = await response.json();
                
                if (Object.keys(stats).length === 0) {
                    container.innerHTML = '<div class="no-data">üì≠ Nessun voto ricevuto per questa data</div>';
                    return;
                }
                
                renderStats(stats);
            } catch (error) {
                console.error('Errore:', error);
                container.innerHTML = '<div class="no-data">‚ùå Errore nel caricamento</div>';
            }
        }
        
        function renderStats(stats) {
            const container = document.getElementById('statsContainer');
            
            let totalVotes = 0;
            let totalAvg = 0;
            let count = 0;
            
            for (const stat of Object.values(stats)) {
                totalVotes += stat.count;
                totalAvg += stat.media;
                count++;
            }
            
            const overallAvg = count > 0 ? (totalAvg / count).toFixed(2) : 0;
            
            let html = `
                <div class="summary-card">
                    <div class="summary-title">Voti totali ricevuti</div>
                    <div class="summary-number">${totalVotes}</div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        Media generale: ${overallAvg} ‚≠ê
                    </div>
                </div>
            `;
            
            const sortedStats = Object.entries(stats).sort((a, b) => b[1].media - a[1].media);
            
            for (const [piattoId, stat] of sortedStats) {
                const piatto = menuData.piatti.find(p => p.id === parseInt(piattoId));
                if (!piatto) continue;
                
                const fullStars = Math.floor(stat.media);
                const hasHalfStar = stat.media % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                
                let starsHTML = '‚≠ê'.repeat(fullStars);
                if (hasHalfStar) starsHTML += '‚≠ê';
                starsHTML += '‚òÜ'.repeat(emptyStars);
                
                html += `
                    <div class="stats-card">
                        <div class="piatto-name">
                            <span>${piatto.nome}</span>
                            <span style="font-size: 14px; color: #666;">${piatto.categoria}</span>
                        </div>
                        
                        <div class="rating-display">
                            <div class="rating-number">${stat.media.toFixed(1)}</div>
                            <div>
                                <div class="stars-display">${starsHTML}</div>
                                <div class="vote-count">${stat.count} ${stat.count === 1 ? 'voto' : 'voti'}</div>
                            </div>
                        </div>
                        
                        ${stat.commenti && stat.commenti.length > 0 ? `
                            <div class="comments-section">
                                <div class="comments-title">üí¨ Commenti (${stat.commenti.length})</div>
                                ${stat.commenti.map(c => `
                                    <div class="comment-item">
                                        <span class="comment-user">${c.username}:</span>
                                        <span class="comment-text">${c.commento}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function cambiaData() {
            const select = document.getElementById('dataMenu');
            currentDate = select.value;
            if (currentDate) {
                loadStats();
            }
        }
        
        loadAvailableDates();
        loadStats();
        
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Menu del Giorno</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .user-name {
            font-size: 14px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .date-selector {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
        }
        
        .date-selector label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .date-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .info-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .info-box.error {
            background: #fee;
            color: #c33;
        }
        
        .info-box.admin-notice {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1976d2;
        }
        
        .category-section {
            margin-bottom: 30px;
        }
        
        .category-title {
            color: #667eea;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-left: 12px;
            border-left: 4px solid #667eea;
        }
        
        .piatto-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.3s;
        }
        
        .piatto-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .piatto-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .piatto-nome {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        .piatto-prezzo {
            color: #667eea;
            font-weight: 600;
            font-size: 16px;
            margin-left: 10px;
        }
        
        .piatto-descrizione {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .ricetta-section {
            background: #f9f9f9;
            border-left: 3px solid #667eea;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .ricetta-section.visible {
            display: block;
        }
        
        .ricetta-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .ricetta-text {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .ricetta-btn {
            background: #f0f0f0;
            color: #667eea;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.3s;
        }
        
        .ricetta-btn:hover {
            background: #e0e0e0;
        }
        
        .voted-badge {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .rating-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .star {
            font-size: 36px;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
        }
        
        .star:hover {
            transform: scale(1.15);
        }
        
        .star:active {
            transform: scale(0.95);
        }
        
        .comment-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 12px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .comment-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .vote-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .vote-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .vote-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <span class="user-name">üëã Ciao, <strong>{{ username }}</strong></span>
            <div class="header-buttons">
                {% if username == 'admin' %}
                <a href="/valida_csv" class="logout-btn">üîç Valida CSV</a>
                <a href="/ingredienti" class="logout-btn">üõí Lista Spesa</a>
                <a href="/admin" class="logout-btn">üìä Statistiche</a>
                {% endif %}
                <button class="logout-btn" onclick="logout()">Esci</button>
            </div>
        </div>
        <h1>üçΩÔ∏è Menu del Giorno</h1>
        
        <div class="date-selector">
            <label for="dataMenu">üìÖ Seleziona data:</label>
            <select id="dataMenu" onchange="cambiaData()">
                <option value="">Caricamento...</option>
            </select>
        </div>
    </div>
    
    <div class="container" id="menuContainer">
        <div class="loading">
            <div class="spinner"></div>
            Caricamento menu...
        </div>
    </div>
    
    <script>
        let menuData = null;
        let myVotes = {};
        let currentDate = new Date().toISOString().split('T')[0];
        const isAdmin = '{{ username }}' === 'admin';
        
        async function loadAvailableDates() {
            try {
                const response = await fetch('/api/date_disponibili');
                const data = await response.json();
                
                const select = document.getElementById('dataMenu');
                select.innerHTML = '';
                
                if (data.date && data.date.length > 0) {
                    data.date.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = formatDateItalian(date);
                        if (date === currentDate) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Nessuna data disponibile</option>';
                }
            } catch (error) {
                console.error('Errore caricamento date:', error);
            }
        }
        
        async function loadMenu(data = null) {
            try {
                const url = data ? `/api/menu?data=${data}` : '/api/menu';
                const response = await fetch(url);
                
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                
                menuData = await response.json();
                currentDate = menuData.data;
                
                if (!isAdmin) {
                    await loadMyVotes(currentDate);
                }
                
                renderMenu();
            } catch (error) {
                console.error('Errore caricamento menu:', error);
                document.getElementById('menuContainer').innerHTML = 
                    '<div class="info-box error">Errore di caricamento. Ricarica la pagina.</div>';
            }
        }
        
        async function loadMyVotes(data) {
            try {
                const response = await fetch(`/api/miei_voti?data=${data}`);
                const votes = await response.json();
                myVotes = votes;
            } catch (error) {
                console.error('Errore caricamento voti:', error);
            }
        }
        
        function formatDateItalian(dateString) {
            if (!dateString) return 'Data non valida';
            
            try {
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString;
                
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                
                const date = new Date(year, month, day);
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                return date.toLocaleDateString('it-IT', { 
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
            } catch (e) {
                console.error('Errore formattazione data:', e);
                return dateString;
            }
        }
        
        function toggleRicetta(piattoId) {
            const ricettaDiv = document.getElementById(`ricetta-${piattoId}`);
            const button = document.getElementById(`ricetta-btn-${piattoId}`);
            
            if (ricettaDiv.classList.contains('visible')) {
                ricettaDiv.classList.remove('visible');
                button.textContent = 'üìñ Vedi ricetta';
            } else {
                ricettaDiv.classList.add('visible');
                button.textContent = 'üìñ Nascondi ricetta';
            }
        }
        
        function renderMenu() {
            const container = document.getElementById('menuContainer');
            
            if (menuData.error) {
                container.innerHTML = `<div class="info-box error">${menuData.error}</div>`;
                return;
            }
            
            if (!menuData.piatti || menuData.piatti.length === 0) {
                container.innerHTML = `
                    <div class="info-box">
                        üì≠ Nessun piatto disponibile per ${formatDateItalian(menuData.data)}
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Messaggio per admin
            if (isAdmin) {
                html += `
                    <div class="info-box admin-notice">
                        üë®‚Äçüíº <strong>Modalit√† Admin:</strong> Visualizzazione solo menu (senza votazioni)
                    </div>
                `;
            }
            
            const categories = {};
            
            menuData.piatti.forEach(piatto => {
                if (!categories[piatto.categoria]) {
                    categories[piatto.categoria] = [];
                }
                categories[piatto.categoria].push(piatto);
            });
            
            for (const [categoria, piatti] of Object.entries(categories)) {
                html += `
                    <div class="category-section">
                        <h2 class="category-title">${categoria}</h2>
                        ${piatti.map(piatto => renderPiatto(piatto)).join('')}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function renderPiatto(piatto) {
            const voted = myVotes[piatto.id];
            const currentRating = voted ? voted.voto : 0;
            const currentComment = voted ? voted.commento : '';
            const hasRicetta = piatto.ricetta && piatto.ricetta.length > 0;
            
            // Versione semplificata per admin (solo visualizzazione)
            if (isAdmin) {
                return `
                    <div class="piatto-card">
                        <div class="piatto-header">
                            <div class="piatto-nome">${piatto.nome}</div>
                            <div class="piatto-prezzo">${piatto.prezzo}</div>
                        </div>
                        <div class="piatto-descrizione">${piatto.descrizione}</div>
                        
                        ${hasRicetta ? `
                            <button class="ricetta-btn" id="ricetta-btn-${piatto.id}" onclick="toggleRicetta(${piatto.id})">
                                üìñ Vedi ricetta
                            </button>
                            <div class="ricetta-section" id="ricetta-${piatto.id}">
                                <div class="ricetta-title">üìñ Ricetta:</div>
                                <div class="ricetta-text">${piatto.ricetta}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Versione completa per utenti normali (con votazioni)
            return `
                <div class="piatto-card">
                    <div class="piatto-header">
                        <div class="piatto-nome">${piatto.nome}</div>
                        <div class="piatto-prezzo">${piatto.prezzo}</div>
                    </div>
                    <div class="piatto-descrizione">${piatto.descrizione}</div>
                    
                    ${hasRicetta ? `
                        <button class="ricetta-btn" id="ricetta-btn-${piatto.id}" onclick="toggleRicetta(${piatto.id})">
                            üìñ Vedi ricetta
                        </button>
                        <div class="ricetta-section" id="ricetta-${piatto.id}">
                            <div class="ricetta-title">üìñ Ricetta:</div>
                            <div class="ricetta-text">${piatto.ricetta}</div>
                        </div>
                    ` : ''}
                    
                    ${voted ? `<div class="voted-badge">‚úì Hai gi√† votato: ${voted.voto}‚≠ê</div>` : ''}
                    
                    <div class="rating-container" id="rating-${piatto.id}" data-rating="${currentRating}">
                        ${[1,2,3,4,5].map(star => `
                            <span class="star" onclick="setRating(${piatto.id}, ${star})">
                                ${star <= currentRating ? '‚≠ê' : '‚òÜ'}
                            </span>
                        `).join('')}
                    </div>
                    
                    <input type="text" 
                           class="comment-input" 
                           id="comment-${piatto.id}" 
                           placeholder="Aggiungi un commento (opzionale)..."
                           value="${currentComment}">
                    
                    <button class="vote-btn" 
                            id="btn-${piatto.id}" 
                            onclick="submitVote(${piatto.id})"
                            ${currentRating === 0 ? 'disabled' : ''}>
                        ${voted ? '‚úèÔ∏è Aggiorna voto' : 'üìù Invia voto'}
                    </button>
                </div>
            `;
        }
        
        function setRating(piattoId, rating) {
            if (isAdmin) return; // Admin non pu√≤ votare
            
            const container = document.getElementById(`rating-${piattoId}`);
            const stars = container.querySelectorAll('.star');
            
            stars.forEach((star, index) => {
                star.textContent = index < rating ? '‚≠ê' : '‚òÜ';
            });
            
            container.dataset.rating = rating;
            document.getElementById(`btn-${piattoId}`).disabled = false;
        }
        
        async function submitVote(piattoId) {
            if (isAdmin) return; // Admin non pu√≤ votare
            
            const ratingContainer = document.getElementById(`rating-${piattoId}`);
            const rating = parseInt(ratingContainer.dataset.rating);
            const comment = document.getElementById(`comment-${piattoId}`).value.trim();
            const button = document.getElementById(`btn-${piattoId}`);
            
            if (!rating || rating < 1) {
                alert('‚ö†Ô∏è Seleziona un voto prima di inviare!');
                return;
            }
            
            button.textContent = 'Invio in corso...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/vota', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        piatto_id: piattoId,
                        voto: rating,
                        commento: comment,
                        data_menu: currentDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await loadMenu(currentDate);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    setTimeout(() => {
                        alert('‚úÖ Voto salvato con successo!');
                    }, 300);
                } else if (data.error) {
                    alert('‚ùå ' + data.error);
                    button.textContent = 'üìù Invia voto';
                    button.disabled = false;
                }
            } catch (error) {
                alert('‚ùå Errore durante il salvataggio. Riprova.');
                button.textContent = 'üìù Invia voto';
                button.disabled = false;
            }
        }
        
        function cambiaData() {
            const select = document.getElementById('dataMenu');
            const dataSelezionata = select.value;
            if (dataSelezionata) {
                loadMenu(dataSelezionata);
            }
        }
        
        function logout() {
            if (confirm('Vuoi davvero uscire?')) {
                window.location.href = '/logout';
            }
        }
        
        // Inizializzazione
        loadAvailableDates();
        loadMenu();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Spesa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 40px;
        }
        
        .header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        h1 {
            font-size: 24px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 13px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .selection-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        /* Tab switching */
        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .mode-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .mode-tab.active {
            color: #28a745;
            border-bottom-color: #28a745;
        }
        
        .mode-tab:hover {
            color: #28a745;
        }
        
        .mode-content {
            display: none;
        }
        
        .mode-content.active {
            display: block;
        }
        
        /* Settimane selector */
        .week-selector {
            margin-bottom: 20px;
        }
        
        .week-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .week-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .week-selector select:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .date-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .date-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .date-checkbox:hover {
            background: #e8f5e9;
        }
        
        .date-checkbox input {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .date-checkbox label {
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .persone-input {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .persone-input label {
            font-weight: 500;
            color: #333;
        }
        
        .persone-input input {
            width: 100px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .calculate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .calculate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1565c0;
        }
        
        .lista-spesa-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: none;
        }
        
        .lista-spesa-card.visible {
            display: block;
        }
        
        .lista-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #28a745;
        }
        
        .lista-title {
            font-size: 22px;
            font-weight: 600;
            color: #28a745;
        }
        
        .print-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .lista-info {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #2e7d32;
        }
        
        .categoria-section {
            margin-bottom: 25px;
        }
        
        .categoria-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .categoria-icon {
            font-size: 20px;
        }
        
        .ingredienti-list {
            display: grid;
            gap: 8px;
            padding-left: 10px;
        }
        
        .ingrediente-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .ingrediente-nome {
            font-weight: 500;
            color: #333;
        }
        
        .ingrediente-quantita {
            font-weight: 600;
            color: #28a745;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #28a745;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media print {
            .header, .selection-card, .back-btn, .print-btn {
                display: none;
            }
            
            body {
                background: white;
            }
            
            .lista-spesa-card {
                box-shadow: none;
                page-break-inside: avoid;
            }
            
            .categoria-section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üõí Lista Spesa</h1>
            <div class="header-buttons">
                <a href="/valida_csv" class="back-btn">üîç Valida CSV</a>
                <a href="/admin" class="back-btn">üìä Statistiche</a>
                <a href="/" class="back-btn">‚Üê Menu</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="selection-card">
            <!-- Tab per scegliere modalit√† -->
            <div class="mode-tabs">
                <button class="mode-tab active" onclick="switchMode('week')">
                    üìÖ Per Settimana
                </button>
                <button class="mode-tab" onclick="switchMode('dates')">
                    üìÜ Per Date Specifiche
                </button>
            </div>
            
            <!-- Modalit√†: Selezione per settimana -->
            <div id="weekMode" class="mode-content active">
                <div class="info-box">
                    üí° Seleziona una settimana per calcolare automaticamente la lista spesa di tutti i giorni di quella settimana.
                </div>
                
                <div class="week-selector">
                    <label for="weekSelect">Seleziona settimana:</label>
                    <select id="weekSelect">
                        <option value="">Caricamento settimane...</option>
                    </select>
                </div>
            </div>
            
            <!-- Modalit√†: Selezione per date -->
            <div id="datesMode" class="mode-content">
                <div class="info-box">
                    üí° Seleziona le singole giornate per cui vuoi calcolare la lista spesa.
                </div>
                
                <div class="section-title">üìÖ Seleziona le giornate:</div>
                <div class="date-checkboxes" id="dateCheckboxes">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento date...
                    </div>
                </div>
            </div>
            
            <!-- Numero persone (comune) -->
            <div class="section-title" style="margin-top: 20px;">üë• Numero di persone:</div>
            <div class="persone-input">
                <label for="numPersone">Persone:</label>
                <input type="number" id="numPersone" min="1" value="1" />
            </div>
            
            <button class="calculate-btn" id="calculateBtn" onclick="calcolaListaSpesa()">
                üßÆ Calcola Lista Spesa
            </button>
        </div>
        
        <div class="lista-spesa-card" id="listaSpesaCard">
            <div class="lista-header">
                <div class="lista-title">üìù Lista della Spesa</div>
                <button class="print-btn" onclick="window.print()">üñ®Ô∏è Stampa</button>
            </div>
            
            <div class="lista-info" id="listaInfo"></div>
            
            <div id="categorieContainer"></div>
        </div>
    </div>
    
    <script>
        let availableDates = [];
        let availableWeeks = [];
        let currentMode = 'week';
        
        const ICONE_CATEGORIE = {
            'Frutta e Verdura': 'ü•¨',
            'Macelleria e Pescheria': 'ü•©',
            'Latticini e Uova': 'üßÄ',
            'Dispensa e Cereali': 'üåæ',
            'Bevande': 'üç∑',
            'Dolci e Dessert': 'üç∞',
            'Surgelati': 'üßä',
            'Altri': 'üì¶'
        };
        
        function switchMode(mode) {
            currentMode = mode;
            
            // Update tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.mode-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (mode === 'week') {
                document.getElementById('weekMode').classList.add('active');
            } else {
                document.getElementById('datesMode').classList.add('active');
            }
            
            updateButton();
        }
        
        async function loadWeeks() {
            try {
                const response = await fetch('/api/settimane_disponibili');
                const data = await response.json();
                availableWeeks = data.settimane || [];
                
                renderWeekSelector();
            } catch (error) {
                console.error('Errore caricamento settimane:', error);
                document.getElementById('weekSelect').innerHTML = 
                    '<option value="">Errore caricamento settimane</option>';
            }
        }
        
        function renderWeekSelector() {
            const select = document.getElementById('weekSelect');
            
            if (availableWeeks.length === 0) {
                select.innerHTML = '<option value="">Nessuna settimana disponibile</option>';
                return;
            }
            
            let html = '<option value="">-- Seleziona una settimana --</option>';
            availableWeeks.forEach(week => {
                const value = `${week.anno}-${week.settimana}`;
                html += `<option value="${value}">${week.label}</option>`;
            });
            
            select.innerHTML = html;
        }
        
        async function loadDates() {
            try {
                const response = await fetch('/api/date_disponibili');
                const data = await response.json();
                availableDates = data.date || [];
                
                renderDateCheckboxes();
            } catch (error) {
                console.error('Errore caricamento date:', error);
                document.getElementById('dateCheckboxes').innerHTML = 
                    '<div style="color: #c33;">Errore caricamento date</div>';
            }
        }
        
        function formatDateItalian(dateString) {
            if (!dateString) return 'Data non valida';
            
            try {
                const parts = dateString.split('-');
                if (parts.length !== 3) return dateString;
                
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                
                const date = new Date(year, month, day);
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                return date.toLocaleDateString('it-IT', { 
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function renderDateCheckboxes() {
            const container = document.getElementById('dateCheckboxes');
            
            if (availableDates.length === 0) {
                container.innerHTML = '<div style="color: #999;">Nessuna data disponibile</div>';
                return;
            }
            
            let html = '';
            availableDates.forEach(date => {
                html += `
                    <div class="date-checkbox">
                        <input type="checkbox" id="date-${date}" value="${date}" onchange="updateButton()">
                        <label for="date-${date}">${formatDateItalian(date)}</label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function updateButton() {
            const button = document.getElementById('calculateBtn');
            
            if (currentMode === 'week') {
                const weekSelect = document.getElementById('weekSelect');
                button.disabled = !weekSelect.value;
            } else {
                const checkboxes = document.querySelectorAll('.date-checkbox input[type="checkbox"]');
                const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                button.disabled = !anyChecked;
            }
        }
        
        async function calcolaListaSpesa() {
            const numPersone = parseInt(document.getElementById('numPersone').value) || 1;
            let dateSelezionate = [];
            
            // Ottieni date in base alla modalit√†
            if (currentMode === 'week') {
                const weekValue = document.getElementById('weekSelect').value;
                if (!weekValue) {
                    alert('‚ö†Ô∏è Seleziona una settimana!');
                    return;
                }
                
                const [anno, settimana] = weekValue.split('-').map(Number);
                
                // Ottieni date della settimana
                try {
                    const response = await fetch(`/api/date_da_settimana?anno=${anno}&settimana=${settimana}`);
                    const data = await response.json();
                    dateSelezionate = data.date;
                    
                    if (dateSelezionate.length === 0) {
                        alert('‚ö†Ô∏è Nessuna data trovata per questa settimana!');
                        return;
                    }
                } catch (error) {
                    alert('‚ùå Errore nel caricamento date settimana');
                    return;
                }
            } else {
                const checkboxes = document.querySelectorAll('.date-checkbox input[type="checkbox"]:checked');
                dateSelezionate = Array.from(checkboxes).map(cb => cb.value);
                
                if (dateSelezionate.length === 0) {
                    alert('‚ö†Ô∏è Seleziona almeno una data!');
                    return;
                }
            }
            
            const button = document.getElementById('calculateBtn');
            button.textContent = '‚è≥ Calcolo in corso...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/lista_spesa', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: dateSelezionate,
                        num_persone: numPersone
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    renderListaSpesa(data);
                } else {
                    alert('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'));
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('‚ùå Errore durante il calcolo');
            } finally {
                button.textContent = 'üßÆ Calcola Lista Spesa';
                updateButton();
            }
        }
        
        function renderListaSpesa(data) {
            const card = document.getElementById('listaSpesaCard');
            const info = document.getElementById('listaInfo');
            const container = document.getElementById('categorieContainer');
            
            // Info header
            const dateFormatted = data.date.map(d => formatDateItalian(d)).join(', ');
            info.innerHTML = `
                <strong>üìÖ Date selezionate:</strong> ${dateFormatted}<br>
                <strong>üë• Numero persone:</strong> ${data.num_persone}<br>
                <strong>üì¶ Totale ingredienti:</strong> ${data.totale_ingredienti}
            `;
            
            // Lista per categorie
            let html = '';
            
            data.lista_spesa.forEach(categoria => {
                const icona = ICONE_CATEGORIE[categoria.categoria] || 'üì¶';
                
                html += `
                    <div class="categoria-section">
                        <div class="categoria-header">
                            <span class="categoria-icon">${icona}</span>
                            <span>${categoria.categoria} (${categoria.ingredienti.length})</span>
                        </div>
                        <div class="ingredienti-list">
                            ${categoria.ingredienti.map(item => `
                                <div class="ingrediente-row">
                                    <div class="ingrediente-nome">${item.ingrediente}</div>
                                    <div class="ingrediente-quantita">${item.quantita}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            card.classList.add('visible');
            
            // Scroll to lista
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Inizializzazione
        loadWeeks();
        loadDates();
        updateButton();
        
        // Event listener per select settimana
        document.getElementById('weekSelect').addEventListener('change', updateButton);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Menu del Giorno</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
            text-align: center;
        }
        
        .beta-badge {
            background: #ffd700;
            color: #333;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: block;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="beta-badge">üîí ACCESSO RISERVATO</div>
        <h1>üçΩÔ∏è Menu del Giorno</h1>
        <p class="subtitle">Accedi per votare i piatti</p>
        
        <div class="error" id="error"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required autocomplete="username" autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required autocomplete="current-password">
            </div>
            
            <button type="submit">Accedi</button>
        </form>
    </div>
    
    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            const button = e.target.querySelector('button');
            
            button.textContent = 'Accesso in corso...';
            button.disabled = true;
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.href = '/';
                } else {
                    errorDiv.textContent = data.message || 'Credenziali non valide';
                    errorDiv.style.display = 'block';
                    button.textContent = 'Accedi';
                    button.disabled = false;
                }
            } catch (error) {
                errorDiv.textContent = 'Errore di connessione';
                errorDiv.style.display = 'block';
                button.textContent = 'Accedi';
                button.disabled = false;
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida CSV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 40px;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        h1 {
            font-size: 24px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 13px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .info-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .info-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .info-text {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .warning-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 8px;
        }
        
        .warning-text {
            color: #856404;
            font-size: 14px;
        }
        
        .validate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }
        
        .validate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .validate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .results-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: none;
        }
        
        .results-card.visible {
            display: block;
        }
        
        .results-card.success {
            border-left: 4px solid #28a745;
        }
        
        .results-card.error {
            border-left: 4px solid #dc3545;
        }
        
        .results-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .results-title.success {
            color: #28a745;
        }
        
        .results-title.error {
            color: #dc3545;
        }
        
        .results-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .results-summary div {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .results-summary strong {
            color: #333;
        }
        
        .error-list {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .error-item {
            padding: 8px;
            margin-bottom: 6px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
        
        .error-item.fix {
            border-left: 3px solid #28a745;
        }
        
        .error-item.warning {
            border-left: 3px solid #ffc107;
        }
        
        .error-item.error {
            border-left: 3px solid #dc3545;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .checks-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .check-item {
            padding: 8px 0;
            font-size: 14px;
            color: #666;
        }
        
        .check-item::before {
            content: "‚úì ";
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üîç Validazione File CSV</h1>
            <div class="header-buttons">
                <a href="/ingredienti" class="back-btn">üõí Lista Spesa</a>
                <a href="/admin" class="back-btn">üìä Statistiche</a>
                <a href="/" class="back-btn">‚Üê Menu</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="info-card">
            <div class="info-title">üìã Cosa fa questo strumento?</div>
            <div class="info-text">
                Questo strumento analizza il file <strong>menu_database.csv</strong> e corregge automaticamente 
                gli errori comuni che potrebbero impedire il corretto funzionamento dell'applicazione.
            </div>
            
            <div class="checks-list">
                <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Controlli effettuati:</div>
                <div class="check-item">Rimozione spazi extra prima e dopo i valori</div>
                <div class="check-item">Rimozione caratteri invisibili (BOM)</div>
                <div class="check-item">Standardizzazione formato date</div>
                <div class="check-item">Correzione formato prezzi</div>
                <div class="check-item">Validazione campo "attivo" (SI/NO)</div>
                <div class="check-item">Pulizia liste ingredienti e quantit√†</div>
                <div class="check-item">Verifica coerenza numero ingredienti/quantit√†</div>
                <div class="check-item">Rimozione righe vuote</div>
                <div class="check-item">Correzione intestazione (header)</div>
            </div>
            
            <div class="warning-box">
                <div class="warning-title">‚ö†Ô∏è Importante</div>
                <div class="warning-text">
                    Prima di procedere, verr√† creato automaticamente un <strong>backup</strong> del file originale 
                    con estensione <code>.backup</code>. In caso di problemi potrai ripristinare il file originale.
                </div>
            </div>
            
            <button class="validate-btn" id="validateBtn" onclick="validaCsv()">
                üîç Avvia Validazione e Correzione
            </button>
        </div>
        
        <div class="results-card" id="resultsCard">
            <div class="results-title" id="resultsTitle">Risultati</div>
            
            <div class="results-summary" id="resultsSummary"></div>
            
            <div id="errorsList"></div>
        </div>
    </div>
    
    <script>
        async function validaCsv() {
            const button = document.getElementById('validateBtn');
            const resultsCard = document.getElementById('resultsCard');
            const resultsTitle = document.getElementById('resultsTitle');
            const resultsSummary = document.getElementById('resultsSummary');
            const errorsList = document.getElementById('errorsList');
            
            // Reset
            resultsCard.classList.remove('visible', 'success', 'error');
            resultsTitle.classList.remove('success', 'error');
            
            // Loading
            button.textContent = '‚è≥ Validazione in corso...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/valida_csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Successo
                    resultsCard.classList.add('visible', 'success');
                    resultsTitle.classList.add('success');
                    resultsTitle.textContent = '‚úÖ Validazione Completata!';
                    
                    resultsSummary.innerHTML = `
                        <div><strong>Righe processate:</strong> ${data.righe_processate}</div>
                        <div><strong>Problemi rilevati e corretti:</strong> ${data.errori_trovati}</div>
                        ${data.backup_file ? `<div><strong>File backup:</strong> ${data.backup_file}</div>` : ''}
                    `;
                    
                    if (data.dettagli && data.dettagli.length > 0) {
                        let errorsHtml = '<div style="font-weight: 600; margin-bottom: 10px; color: #333;">üìù Dettaglio modifiche:</div>';
                        errorsHtml += '<div class="error-list">';
                        
                        data.dettagli.forEach(errore => {
                            let className = 'fix';
                            if (errore.includes('‚ùå')) className = 'error';
                            else if (errore.includes('‚ö†Ô∏è')) className = 'warning';
                            
                            errorsHtml += `<div class="error-item ${className}">${errore}</div>`;
                        });
                        
                        errorsHtml += '</div>';
                        errorsList.innerHTML = errorsHtml;
                    } else {
                        errorsList.innerHTML = '<div style="padding: 15px; text-align: center; color: #28a745;">‚ú® Nessun errore trovato! Il file CSV √® perfetto.</div>';
                    }
                    
                    // Suggerisci ricarica
                    setTimeout(() => {
                        if (confirm('‚úÖ Validazione completata! Vuoi ricaricare la pagina per applicare le modifiche?')) {
                            window.location.href = '/';
                        }
                    }, 1000);
                    
                } else {
                    // Errore
                    resultsCard.classList.add('visible', 'error');
                    resultsTitle.classList.add('error');
                    resultsTitle.textContent = '‚ùå Errore durante la validazione';
                    
                    resultsSummary.innerHTML = `
                        <div style="color: #dc3545;"><strong>Errore:</strong> ${data.error}</div>
                    `;
                    
                    errorsList.innerHTML = '';
                }
                
            } catch (error) {
                console.error('Errore:', error);
                
                resultsCard.classList.add('visible', 'error');
                resultsTitle.classList.add('error');
                resultsTitle.textContent = '‚ùå Errore di connessione';
                
                resultsSummary.innerHTML = `
                    <div style="color: #dc3545;">Si √® verificato un errore durante la comunicazione con il server.</div>
                `;
                
                errorsList.innerHTML = '';
            } finally {
                button.textContent = 'üîç Avvia Validazione e Correzione';
                button.disabled = false;
            }
        }
    </script>
</body>
</html>
